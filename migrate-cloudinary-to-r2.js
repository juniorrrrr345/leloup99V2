#!/usr/bin/env node

/**
 * üîÑ MIGRATION COMPL√àTE CLOUDINARY ‚Üí CLOUDFLARE R2 POUR OGLEGACY
 * Script pour t√©l√©charger TOUS les vrais fichiers Cloudinary et les uploader vers R2
 */

const fs = require('fs');
const path = require('path');
const https = require('https');

// Configuration
const CLOUDFLARE_CONFIG = {
  accountId: '7979421604bd07b3bd34d3ed96222512',
  databaseId: '732dfabe-3e2c-4d65-8fdc-bc39eb989434',
  apiToken: 'ijkVhaXCw6LSddIMIMxwPL5CDAWznxip5x9I1bNW',
  r2AccessKeyId: '82WsPNjX-j0UqZIGAny8b0uEehcHd0X3zMKNIKIN',
  r2SecretAccessKey: '28230e200a3b71e5374e569f8a297eba9aa3fe2e1097fdf26e5d9e340ded709d',
  r2BucketName: 'boutique-images',
  r2PublicUrl: 'https://pub-b38679a01a274648827751df94818418.r2.dev'
};

async function executeSqlOnD1(sql, params = []) {
  const url = `https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_CONFIG.accountId}/d1/database/${CLOUDFLARE_CONFIG.databaseId}/query`;
  
  const response = await fetch(url, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${CLOUDFLARE_CONFIG.apiToken}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ sql, params })
  });
  
  if (!response.ok) {
    throw new Error(`D1 Error: ${response.status} ${response.statusText}`);
  }
  
  return await response.json();
}

async function downloadFile(url, filepath) {
  return new Promise((resolve, reject) => {
    console.log(`    üì• T√©l√©chargement: ${url}`);
    
    const file = fs.createWriteStream(filepath);
    
    https.get(url, (response) => {
      // Suivre les redirections
      if (response.statusCode >= 300 && response.statusCode < 400 && response.headers.location) {
        console.log(`    üîÑ Redirection vers: ${response.headers.location}`);
        return downloadFile(response.headers.location, filepath).then(resolve).catch(reject);
      }
      
      if (response.statusCode !== 200) {
        reject(new Error(`HTTP ${response.statusCode}: ${response.statusMessage}`));
        return;
      }
      
      let totalBytes = 0;
      const contentLength = parseInt(response.headers['content-length'] || '0');
      
      response.on('data', (chunk) => {
        totalBytes += chunk.length;
        if (contentLength > 0) {
          const percent = Math.round((totalBytes / contentLength) * 100);
          process.stdout.write(`\r    üìä Progression: ${percent}% (${Math.round(totalBytes/1024)}KB)`);
        }
      });
      
      response.pipe(file);
      
      file.on('finish', () => {
        file.close();
        console.log(`\n    ‚úÖ T√©l√©charg√©: ${Math.round(totalBytes/1024)}KB`);
        resolve();
      });
      
      file.on('error', (err) => {
        fs.unlink(filepath, () => {}); // Supprimer le fichier en cas d'erreur
        reject(err);
      });
    }).on('error', (err) => {
      reject(err);
    });
  });
}

async function uploadToR2(filePath, fileName, isVideo = false) {
  try {
    console.log(`    üì§ Upload vers R2: ${fileName}`);
    
    const folder = isVideo ? 'videos' : 'images';
    const stats = fs.statSync(filePath);
    console.log(`    üìä Taille fichier: ${Math.round(stats.size/1024)}KB`);
    
    // Lire le fichier
    const fileBuffer = fs.readFileSync(filePath);
    
    // D√©terminer le content-type
    const ext = path.extname(fileName).toLowerCase();
    let contentType = 'application/octet-stream';
    
    if (['.jpg', '.jpeg'].includes(ext)) contentType = 'image/jpeg';
    else if (ext === '.png') contentType = 'image/png';
    else if (ext === '.webp') contentType = 'image/webp';
    else if (ext === '.mp4') contentType = 'video/mp4';
    else if (ext === '.webm') contentType = 'video/webm';
    else if (ext === '.mov') contentType = 'video/quicktime';
    
    // Upload direct vers R2 via API Cloudflare
    const uploadUrl = `https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_CONFIG.accountId}/r2/buckets/${CLOUDFLARE_CONFIG.r2BucketName}/objects/${folder}/${fileName}`;
    
    const response = await fetch(uploadUrl, {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${CLOUDFLARE_CONFIG.apiToken}`,
        'Content-Type': contentType,
        'Content-Length': fileBuffer.length.toString()
      },
      body: fileBuffer
    });
    
    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`R2 Upload Error: ${response.status} - ${errorText}`);
    }
    
    const r2Url = `${CLOUDFLARE_CONFIG.r2PublicUrl}/${folder}/${fileName}`;
    console.log(`    ‚úÖ Upload√© vers R2: ${r2Url}`);
    
    return r2Url;
  } catch (error) {
    console.error(`    ‚ùå Erreur upload R2:`, error.message);
    throw error;
  }
}

async function migrateAllFiles() {
  console.log('üîÑ MIGRATION COMPL√àTE CLOUDINARY ‚Üí CLOUDFLARE R2');
  console.log('================================================');
  console.log('üìã R√©cup√©ration de TOUS les vrais fichiers Cloudinary...\n');
  
  try {
    // Cr√©er dossier temporaire
    const tempDir = './temp_migration';
    if (fs.existsSync(tempDir)) {
      fs.rmSync(tempDir, { recursive: true });
    }
    fs.mkdirSync(tempDir);
    console.log(`üìÅ Dossier temporaire cr√©√©: ${tempDir}\n`);
    
    // 1. R√©cup√©rer TOUTES les URLs Cloudinary depuis D1
    console.log('üìä R√©cup√©ration des produits avec URLs Cloudinary...');
    const result = await executeSqlOnD1(`
      SELECT id, name, image_url, video_url 
      FROM products 
      WHERE image_url LIKE '%pub-b38679a01a274648827751df94818418.r2.dev%' 
         OR video_url LIKE '%pub-b38679a01a274648827751df94818418.r2.dev%'
    `);
    
    if (!result.result?.[0]?.results?.length) {
      console.log('‚ö†Ô∏è  Aucun produit avec URLs R2 trouv√©. R√©cup√©ration des URLs Cloudinary originales...');
      
      // R√©cup√©rer les URLs Cloudinary originales depuis les donn√©es de sauvegarde
      const originalUrls = [
        {
          id: 1, name: 'OREOZ',
          image_url: 'https://res.cloudinary.com/dmfutgwh0/image/upload/v1755690421/boutique_images/upload_1755690421215.jpg',
          video_url: 'https://res.cloudinary.com/dmfutgwh0/video/upload/v1755631069/boutique_videos/upload_1755631069564.mp4'
        },
        {
          id: 2, name: 'JOLLY RANCHERS üç¨',
          image_url: 'https://res.cloudinary.com/dmfutgwh0/image/upload/v1755631871/boutique_images/upload_1755631871417.jpg',
          video_url: 'https://res.cloudinary.com/dmfutgwh0/video/upload/v1755631705/boutique_videos/upload_1755631704844.mp4'
        },
        {
          id: 3, name: 'GOLDEN FINGERS ‚ú®',
          image_url: 'https://res.cloudinary.com/dmfutgwh0/image/upload/v1755690848/boutique_images/upload_1755690848872.jpg',
          video_url: 'https://res.cloudinary.com/dmfutgwh0/video/upload/v1755631972/boutique_videos/upload_1755631972802.mp4'
        },
        {
          id: 4, name: 'GEORGIA PIE üçë',
          image_url: 'https://res.cloudinary.com/dmfutgwh0/image/upload/v1755632638/boutique_images/upload_1755632638929.webp',
          video_url: 'https://res.cloudinary.com/dmfutgwh0/video/upload/v1755638000/boutique_videos/upload_1755638000857.mp4'
        },
        {
          id: 5, name: 'OLIVE FILTRE PREMIUM 120U ‚ö°Ô∏è',
          image_url: 'https://res.cloudinary.com/dmfutgwh0/image/upload/v1755638628/boutique_images/upload_1755638628223.jpg',
          video_url: 'https://res.cloudinary.com/dmfutgwh0/video/upload/v1755641252/boutique_videos/upload_1755641251927.mp4'
        },
        {
          id: 6, name: 'CALI JAUNE USA üá∫üá∏‚ö°Ô∏è',
          image_url: 'https://res.cloudinary.com/dmfutgwh0/image/upload/v1755647880/boutique_images/upload_1755647880075.jpg',
          video_url: 'https://res.cloudinary.com/dmfutgwh0/video/upload/v1755647731/boutique_videos/upload_1755647731660.mp4'
        },
        {
          id: 7, name: 'ICE CREAM CAKE üç∞',
          image_url: 'https://res.cloudinary.com/dmfutgwh0/image/upload/v1756646705/boutique_images/upload_1756646705150.webp',
          video_url: 'https://res.cloudinary.com/dmfutgwh0/video/upload/v1756646988/boutique_videos/upload_1756646988414.mp4'
        },
        {
          id: 8, name: 'CHEETAH PISS üå∫',
          image_url: 'https://res.cloudinary.com/dmfutgwh0/image/upload/v1756647251/boutique_images/upload_1756647251741.jpg',
          video_url: 'https://res.cloudinary.com/dmfutgwh0/video/upload/v1756650709/boutique_videos/upload_1756650709282.mp4'
        }
      ];
      
      console.log(`üìä ${originalUrls.length} produits avec URLs Cloudinary originales trouv√©s\n`);
      
      const successfulMigrations = [];
      
      // 2. Traiter chaque produit
      for (const product of originalUrls) {
        console.log(`üõçÔ∏è TRAITEMENT: ${product.name}`);
        console.log(`   ID: ${product.id}`);
        
        let newImageUrl = product.image_url;
        let newVideoUrl = product.video_url;
        let migrationSuccess = false;
        
        // Traiter l'image
        if (product.image_url && product.image_url.includes('cloudinary')) {
          try {
            console.log('  üì∑ MIGRATION IMAGE:');
            const imageFileName = product.image_url.split('/').pop();
            const tempImagePath = path.join(tempDir, `image_${product.id}_${imageFileName}`);
            
            await downloadFile(product.image_url, tempImagePath);
            
            // Upload vers R2
            newImageUrl = await uploadToR2(tempImagePath, imageFileName, false);
            migrationSuccess = true;
            
            // Nettoyer
            fs.unlinkSync(tempImagePath);
            console.log('  ‚úÖ Image migr√©e avec succ√®s\n');
            
          } catch (error) {
            console.error(`  ‚ùå Erreur migration image: ${error.message}\n`);
          }
        }
        
        // Traiter la vid√©o
        if (product.video_url && product.video_url.includes('cloudinary')) {
          try {
            console.log('  üé• MIGRATION VID√âO:');
            const videoFileName = product.video_url.split('/').pop();
            const tempVideoPath = path.join(tempDir, `video_${product.id}_${videoFileName}`);
            
            await downloadFile(product.video_url, tempVideoPath);
            
            // Upload vers R2
            newVideoUrl = await uploadToR2(tempVideoPath, videoFileName, true);
            migrationSuccess = true;
            
            // Nettoyer
            fs.unlinkSync(tempVideoPath);
            console.log('  ‚úÖ Vid√©o migr√©e avec succ√®s\n');
            
          } catch (error) {
            console.error(`  ‚ùå Erreur migration vid√©o: ${error.message}\n`);
          }
        }
        
        // Mettre √† jour en base D1 si migration r√©ussie
        if (migrationSuccess) {
          try {
            await executeSqlOnD1(
              'UPDATE products SET image_url = ?, video_url = ? WHERE id = ?',
              [newImageUrl, newVideoUrl, product.id]
            );
            
            console.log(`  ‚úÖ Base D1 mise √† jour pour ${product.name}\n`);
            
            successfulMigrations.push({
              id: product.id,
              name: product.name,
              imageUrl: newImageUrl,
              videoUrl: newVideoUrl
            });
            
          } catch (error) {
            console.error(`  ‚ùå Erreur mise √† jour D1: ${error.message}\n`);
          }
        }
        
        console.log('‚îÄ'.repeat(60));
      }
      
      // Nettoyer le dossier temporaire
      if (fs.existsSync(tempDir)) {
        fs.rmSync(tempDir, { recursive: true });
      }
      
      console.log('\nüéâ MIGRATION TERMIN√âE !');
      console.log('======================');
      console.log(`‚úÖ ${successfulMigrations.length}/${originalUrls.length} produits migr√©s avec succ√®s\n`);
      
      if (successfulMigrations.length > 0) {
        console.log('üìã PRODUITS MIGR√âS:');
        successfulMigrations.forEach(product => {
          console.log(`\nüõçÔ∏è ${product.name} (ID: ${product.id}):`);
          console.log(`  üì∑ Image: ${product.imageUrl}`);
          console.log(`  üé• Vid√©o: ${product.videoUrl}`);
        });
        
        console.log('\nüöÄ R√âSULTAT:');
        console.log('‚úÖ Tous les fichiers sont maintenant sur Cloudflare R2');
        console.log('‚úÖ Les URLs en base D1 ont √©t√© mises √† jour');
        console.log('‚úÖ Les images et vid√©os devraient maintenant s\'afficher');
        console.log('‚úÖ Plus de d√©pendance √† Cloudinary !');
      }
      
    } else {
      console.log('‚úÖ Les produits utilisent d√©j√† Cloudflare R2');
    }
    
  } catch (error) {
    console.error('‚ùå Erreur g√©n√©rale:', error.message);
  }
}

// Ex√©cuter la migration
migrateAllFiles();