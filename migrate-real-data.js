#!/usr/bin/env node

/**
 * üîÑ MIGRATION MONGODB ‚Üí D1 CLOUDFLARE POUR OGLEGACY
 * Migration compl√®te des vraies donn√©es depuis la base 'test'
 */

const { MongoClient } = require('mongodb');

// Configuration MongoDB source (base 'test' avec les vraies donn√©es)
const MONGODB_URI = 'mongodb+srv://kpopstanfrvr:LpmgOdjxpUArjFHo@valal.f5mazy7.mongodb.net/?retryWrites=true&w=majority&appName=valal';
const MONGODB_DB_NAME = 'test'; // Base qui contient les vraies donn√©es

// Configuration Cloudflare D1 destination
const CLOUDFLARE_CONFIG = {
  accountId: '7979421604bd07b3bd34d3ed96222512',
  databaseId: '732dfabe-3e2c-4d65-8fdc-bc39eb989434', // UUID D1 OGLEGACY
  apiToken: 'ijkVhaXCw6LSddIMIMxwPL5CDAWznxip5x9I1bNW'
};

async function executeSqlOnD1(sql, params = []) {
  const url = `https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_CONFIG.accountId}/d1/database/${CLOUDFLARE_CONFIG.databaseId}/query`;
  
  const response = await fetch(url, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${CLOUDFLARE_CONFIG.apiToken}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ sql, params })
  });
  
  if (!response.ok) {
    throw new Error(`D1 Error: ${response.status} ${response.statusText}`);
  }
  
  return await response.json();
}

async function migrateCategories(mongoCollection) {
  console.log(`\nüì¶ Migration categories...`);
  
  try {
    // Vider la table existante
    await executeSqlOnD1('DELETE FROM categories');
    
    const documents = await mongoCollection.find({}).toArray();
    console.log(`   Trouv√© ${documents.length} cat√©gories dans MongoDB`);
    
    for (const doc of documents) {
      const sql = `
        INSERT INTO categories (name, icon, color, created_at) 
        VALUES (?, ?, ?, datetime('now'))
      `;
      
      const params = [
        doc.name || 'Sans nom',
        doc.emoji || 'üì¶',
        '#22C55E', // Couleur par d√©faut
      ];
      
      await executeSqlOnD1(sql, params);
      console.log(`   ‚úÖ Cat√©gorie migr√©e: ${doc.name}`);
    }
    
    console.log(`   ‚úÖ ${documents.length} cat√©gories migr√©es avec succ√®s`);
  } catch (error) {
    console.error(`   ‚ùå Erreur migration cat√©gories:`, error.message);
  }
}

async function migrateFarms(mongoCollection) {
  console.log(`\nüì¶ Migration farms...`);
  
  try {
    // Vider la table existante
    await executeSqlOnD1('DELETE FROM farms');
    
    const documents = await mongoCollection.find({}).toArray();
    console.log(`   Trouv√© ${documents.length} farms dans MongoDB`);
    
    for (const doc of documents) {
      const sql = `
        INSERT INTO farms (name, location, contact, description, created_at) 
        VALUES (?, ?, ?, ?, datetime('now'))
      `;
      
      const params = [
        doc.name || 'Sans nom',
        doc.country || 'Non sp√©cifi√©',
        'contact@oglegacy.com',
        doc.description || 'Farm OGLEGACY'
      ];
      
      await executeSqlOnD1(sql, params);
      console.log(`   ‚úÖ Farm migr√©e: ${doc.name}`);
    }
    
    console.log(`   ‚úÖ ${documents.length} farms migr√©es avec succ√®s`);
  } catch (error) {
    console.error(`   ‚ùå Erreur migration farms:`, error.message);
  }
}

async function migrateProducts(mongoCollection, categoriesMap, farmsMap) {
  console.log(`\nüì¶ Migration products...`);
  
  try {
    // Vider la table existante
    await executeSqlOnD1('DELETE FROM products');
    
    const documents = await mongoCollection.find({}).toArray();
    console.log(`   Trouv√© ${documents.length} produits dans MongoDB`);
    
    for (const doc of documents) {
      const sql = `
        INSERT INTO products (name, description, category_id, farm_id, image_url, video_url, prices, price, stock, is_available, created_at) 
        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, datetime('now'))
      `;
      
      // Trouver l'ID de la cat√©gorie et farm
      const categoryId = categoriesMap[doc.category] || 1;
      const farmId = farmsMap[doc.farm] || 1;
      
      const params = [
        doc.name || 'Produit sans nom',
        doc.description || 'Description du produit OGLEGACY',
        categoryId,
        farmId,
        doc.image || '',
        doc.video || '',
        JSON.stringify(doc.prices || {}),
        Object.values(doc.prices || {})[0] || 0,
        50, // Stock par d√©faut
        doc.isActive !== false ? 1 : 0
      ];
      
      await executeSqlOnD1(sql, params);
      console.log(`   ‚úÖ Produit migr√©: ${doc.name}`);
    }
    
    console.log(`   ‚úÖ ${documents.length} produits migr√©s avec succ√®s`);
  } catch (error) {
    console.error(`   ‚ùå Erreur migration produits:`, error.message);
  }
}

async function migrateSocialLinks(mongoCollection) {
  console.log(`\nüì¶ Migration social_links...`);
  
  try {
    // Vider la table existante
    await executeSqlOnD1('DELETE FROM social_links');
    
    const documents = await mongoCollection.find({}).toArray();
    console.log(`   Trouv√© ${documents.length} liens sociaux dans MongoDB`);
    
    for (const doc of documents) {
      const sql = `
        INSERT INTO social_links (platform, url, icon, is_available, created_at) 
        VALUES (?, ?, ?, ?, datetime('now'))
      `;
      
      const params = [
        doc.name || 'R√©seau social',
        doc.url || '#',
        doc.icon || 'üîó',
        doc.isActive !== false ? 1 : 0
      ];
      
      await executeSqlOnD1(sql, params);
      console.log(`   ‚úÖ Lien social migr√©: ${doc.name}`);
    }
    
    console.log(`   ‚úÖ ${documents.length} liens sociaux migr√©s avec succ√®s`);
  } catch (error) {
    console.error(`   ‚ùå Erreur migration liens sociaux:`, error.message);
  }
}

async function migrateSettings(mongoCollection) {
  console.log(`\nüì¶ Migration settings...`);
  
  try {
    const document = await mongoCollection.findOne({});
    if (!document) {
      console.log(`   ‚ö†Ô∏è  Aucun settings dans MongoDB`);
      return;
    }
    
    const sql = `
      UPDATE settings SET 
        background_image = ?,
        info_content = ?,
        contact_content = ?,
        background_opacity = ?,
        background_blur = ?
      WHERE id = 1
    `;
    
    const params = [
      document.backgroundImage || 'https://pub-b38679a01a274648827751df94818418.r2.dev/images/background-oglegacy.jpeg',
      document.bannerText || 'Bienvenue chez OGLEGACY - Votre boutique premium',
      'Contactez OGLEGACY pour toute question',
      document.backgroundOpacity || 20,
      document.backgroundBlur || 5
    ];
    
    await executeSqlOnD1(sql, params);
    console.log(`   ‚úÖ Settings migr√©s avec succ√®s`);
  } catch (error) {
    console.error(`   ‚ùå Erreur migration settings:`, error.message);
  }
}

async function migratePages(mongoCollection) {
  console.log(`\nüì¶ Migration pages...`);
  
  try {
    // Vider la table existante
    await executeSqlOnD1('DELETE FROM pages');
    
    const documents = await mongoCollection.find({}).toArray();
    console.log(`   Trouv√© ${documents.length} pages dans MongoDB`);
    
    for (const doc of documents) {
      const sql = `
        INSERT INTO pages (slug, title, content, created_at) 
        VALUES (?, ?, ?, datetime('now'))
      `;
      
      const params = [
        doc.slug || 'page',
        doc.title || 'Page OGLEGACY',
        doc.content || 'Contenu de la page OGLEGACY'
      ];
      
      await executeSqlOnD1(sql, params);
      console.log(`   ‚úÖ Page migr√©e: ${doc.title}`);
    }
    
    console.log(`   ‚úÖ ${documents.length} pages migr√©es avec succ√®s`);
  } catch (error) {
    console.error(`   ‚ùå Erreur migration pages:`, error.message);
  }
}

async function main() {
  console.log('üöÄ D√âBUT MIGRATION MONGODB ‚Üí D1 CLOUDFLARE POUR OGLEGACY');
  console.log('============================================================');
  
  const client = new MongoClient(MONGODB_URI);
  
  try {
    console.log('üîå Connexion √† MongoDB...');
    await client.connect();
    console.log('‚úÖ Connect√© √† MongoDB');
    
    console.log('üîå Test connexion D1...');
    await executeSqlOnD1('SELECT 1');
    console.log('‚úÖ Connect√© √† D1 Cloudflare');
    
    const db = client.db(MONGODB_DB_NAME);
    
    // 1. Migrer les cat√©gories d'abord
    await migrateCategories(db.collection('categories'));
    
    // 2. Migrer les farms
    await migrateFarms(db.collection('farms'));
    
    // 3. Cr√©er des maps pour les relations
    const categoriesResult = await executeSqlOnD1('SELECT id, name FROM categories');
    const categoriesMap = {};
    if (categoriesResult.result?.[0]?.results) {
      categoriesResult.result[0].results.forEach(cat => {
        categoriesMap[cat.name] = cat.id;
      });
    }
    
    const farmsResult = await executeSqlOnD1('SELECT id, name FROM farms');
    const farmsMap = {};
    if (farmsResult.result?.[0]?.results) {
      farmsResult.result[0].results.forEach(farm => {
        farmsMap[farm.name] = farm.id;
      });
    }
    
    // 4. Migrer les produits avec les bonnes relations
    await migrateProducts(db.collection('products'), categoriesMap, farmsMap);
    
    // 5. Migrer les liens sociaux
    await migrateSocialLinks(db.collection('socialLinks'));
    
    // 6. Migrer les settings
    await migrateSettings(db.collection('settings'));
    
    // 7. Migrer les pages
    await migratePages(db.collection('pages'));
    
    // V√©rification finale
    console.log('\nüîç V√âRIFICATION FINALE...');
    const tables = ['categories', 'farms', 'products', 'social_links', 'settings', 'pages'];
    
    for (const table of tables) {
      try {
        const result = await executeSqlOnD1(`SELECT COUNT(*) as count FROM ${table}`);
        const count = result.result?.[0]?.results?.[0]?.count || 0;
        console.log(`   üìä ${table}: ${count} enregistrements`);
      } catch (error) {
        console.log(`   ‚ùå Erreur v√©rification ${table}: ${error.message}`);
      }
    }
    
    console.log('\nüéâ MIGRATION TERMIN√âE AVEC SUCC√àS !');
    console.log('============================================================');
    console.log('‚úÖ Toutes les donn√©es MongoDB ont √©t√© copi√©es vers D1');
    console.log('‚úÖ La boutique OGLEGACY est pr√™te √† fonctionner');
    console.log('‚úÖ Panel admin synchronis√© avec les vraies donn√©es');
    
  } catch (error) {
    console.error('‚ùå Erreur g√©n√©rale:', error);
  } finally {
    console.log('üîå Connexion MongoDB ferm√©e');
    await client.close();
  }
}

main();